<div class="admin-container">
  <header class="admin-header">
    <div class="title-section">
      <h1>Panel de Intermediación</h1>
      <p>Monitoreo de Scraping y Conversión de Clicks</p>
    </div>
    <div class="action-section">
      <button class="btn-sync" (click)="syncAllSources()">
        Sincronizar Scrapers
      </button>
    </div>
  </header>

  <div class="kpi-container">
    <div class="kpi-card">
      <div class="kpi-header">
        <span class="kpi-title">Salud de Fuentes</span>
      </div>
      <div class="kpi-value">{{ activeSources }}/{{ totalSources }}</div>
      <div class="kpi-subtext" [ngClass]="{'text-danger': failedSources > 0}">
        {{ failedSources }} sitios requieren atención
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <span class="kpi-title">Productos Indexados</span>
      </div>
      <div class="kpi-value">{{ totalScrapedProducts | number }}</div>
      <div class="kpi-subtext text-success">↑ {{ newProductsToday }} nuevos hoy</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <span class="kpi-title">Redirecciones (Clicks)</span>
      </div>
      <div class="kpi-value">{{ totalClicks | number }}</div>
      <div class="kpi-subtext text-primary">Conversión promedio: 8.4%</div>
    </div>
  </div>

  <section class="charts-section">
    <div class="charts-grid">
      <div class="chart-container">
        <h3>Productos por Marketplace</h3>
        <div class="chart-wrapper">
          <canvas id="productsChart"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <h3>Tráfico Generado (Últimos 7 días)</h3>
        <div class="chart-wrapper">
          <canvas id="trafficChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <section class="table-section shadow-sm">
    <div class="table-header">
      <h2>Estado de Sitios Scrapeados</h2>
    </div>
    <div class="table-responsive">
      <table class="custom-table">
        <thead>
          <tr>
            <th>Marketplace</th>
            <th>Última Sincro</th>
            <th>Productos</th>
            <th>Clicks</th>
            <th>Variación</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (site of marketplaceStatus; track site.id) {
            <tr>
              <td>
                <div class="source-cell">
                  <img [src]="site.logo" class="mini-logo" alt="">
                  <strong>{{ site.name }}</strong>
                </div>
              </td>
              <td>{{ site.lastUpdate | date:'HH:mm' }} hs</td>
              <td>{{ site.productCount | number }}</td>
              <td>{{ site.totalClicks }}</td>
              <td>
                <span [class]="site.priceDrop ? 'price-down' : 'price-up'">
                  {{ site.priceDrop ? '↓' : '↑' }} {{ site.avgVariation }}%
                </span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(site.status)">
                  {{ site.status }}
                </span>
              </td>
              <td>
                <button class="btn-action" (click)="retestSource(site.id)" title="Refrescar">⚙️</button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
</div>